<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guanafood - Historial</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style> body{padding:20px;background:#f9f9f9} .venta-item{border-bottom:1px solid #ccc;padding:5px 0;} </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Historial de Ventas</h1>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="desde" class="form-label">Desde</label>
        <input type="date" id="desde" class="form-control">
      </div>
      <div class="col-md-4">
        <label for="hasta" class="form-label">Hasta</label>
        <input type="date" id="hasta" class="form-control">
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-primary w-100" onclick="filtrar()">Filtrar</button>
      </div>
    </div>
    <div id="resultado" class="mb-3"></div>
    <p><strong>Total filtrado: ₡<span id="totalFiltrado">0</span></strong></p>
    <button class="btn btn-success me-2" onclick="descargarPDF()">Descargar PDF</button>
    <a href="index.html" class="btn btn-secondary">Volver</a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const precios = { desayuno:2500, almuerzo:2500, cena:2500, agua:2000 };

    function filtrar() {
      const desde = document.getElementById('desde').value;
      const hasta = document.getElementById('hasta').value;
      const ventas = JSON.parse(localStorage.getItem('ventas')||'[]');
      const res = document.getElementById('resultado');
      res.innerHTML='';
      let total=0;
      ventas.forEach(v=>{
        if((!desde||v.fecha>=desde)&&(!hasta||v.fecha<=hasta)) {
          const sub=v.desayuno*precios.desayuno+v.almuerzo*precios.almuerzo
                    +v.cena*precios.cena+v.agua*precios.agua;
          total+=sub;
          const d=document.createElement('div');
          d.className='venta-item';
          d.textContent=`${v.fecha}: D=${v.desayuno}, A=${v.almuerzo}, C=${v.cena}, B=${v.agua} → ₡${sub}`;
          res.appendChild(d);
        }
      });
      document.getElementById('totalFiltrado').textContent=total;
    }

    document.querySelector('.btn-success').onclick = async ()=>{
      const { jsPDF }=window.jspdf;
      const doc=new jsPDF();
      const canvas=await html2canvas(document.body);
      const img=canvas.toDataURL('image/png');
      doc.addImage(img,'PNG',0,0,doc.internal.pageSize.getWidth(),doc.internal.pageSize.getHeight());
      doc.save('historial_filtrado.pdf');
    };

    window.onload=filtrar;
  </script>
</body>
</html>
